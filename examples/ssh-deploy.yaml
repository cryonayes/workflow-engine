# Example: Remote Deploy via SSH
# This workflow demonstrates SSH remote execution capabilities.
# Tasks are executed on a remote host via SSH.

name: Remote Deploy
description: Deploy application to remote server via SSH

# Workflow-level SSH configuration
# All tasks inherit these settings unless overridden
ssh:
  host: ${{ env.DEPLOY_HOST }}
  user: deployer
  privateKeyPath: ~/.ssh/deploy_key
  workingDirectory: /app
  strictHostKeyChecking: true
  connectionTimeoutSeconds: 30

tasks:
  - id: check-connection
    name: Verify SSH Connection
    run: echo "Connected to $(hostname) as $(whoami)"

  - id: pull-latest
    name: Pull Latest Code
    run: |
      git fetch origin
      git checkout main
      git pull origin main
    dependsOn: [check-connection]

  - id: install-deps
    name: Install Dependencies
    run: |
      npm ci --production
    dependsOn: [pull-latest]

  - id: run-migrations
    name: Run Database Migrations
    run: npm run migrate
    dependsOn: [install-deps]
    # Override SSH config for database tasks
    ssh:
      host: ${{ env.DB_HOST }}
      user: dbadmin
      workingDirectory: /app

  - id: restart-service
    name: Restart Application
    run: |
      sudo systemctl restart myapp
      sleep 5
      systemctl is-active myapp
    dependsOn: [run-migrations]

  - id: health-check
    name: Verify Deployment
    run: curl -f http://localhost:3000/health
    dependsOn: [restart-service]
    retryCount: 3
    retryDelayMs: 2000

  - id: local-notify
    name: Send Notification (Local)
    run: |
      echo "Deployment completed successfully!"
      # This runs locally, not via SSH
    dependsOn: [health-check]
    # Disable SSH for this task to run locally
    ssh:
      disabled: true
